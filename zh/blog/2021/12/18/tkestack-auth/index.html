<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/web/favicons/favicon.ico><link rel=apple-touch-icon href=/web/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/web/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/web/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/web/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/web/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/web/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/web/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/web/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/web/favicons/android-192x192.png sizes=192x192><title>TKEStack 中的认证与鉴权 | Tkestack</title><meta name=description content="生产级别多集群管理系统"><meta property="og:title" content="TKEStack 中的认证与鉴权"><meta property="og:description" content="Author: LeoRyu
认证鉴权对于 K8s 而言可以说是最为复杂、灵活和关键的部分，本文将介绍 TKEStack 中认证鉴权机制是如何运作的。
开始之前 由于认证鉴权涉及的相关知识很多，为了避免读者在下面探究 TKEStack 认证鉴权机制时查处相关名词知识，在开始之前先介绍一些本文涉及到的知识概念。
K8s 中的一些身份认证方式   X509 客户证书。通过给 API 服务器传递 --client-ca-file=SOMEFILE 选项，就可以启动客户端证书身份认证。 所引用的文件必须包含一个或者多个证书机构，用来验证向 API 服务器提供的客户端证书。 如果提供了客户端证书并且证书被验证通过，则 subject 中的公共名称（Common Name）就被 作为请求的用户名。
  静态令牌文件。当 API 服务器的命令行设置了 --token-auth-file=SOMEFILE 选项时，会从文件中 读取持有者令牌。目前，令牌会长期有效，并且在不重启 API 服务器的情况下 无法更改令牌列表。
  服务账号令牌。服务账号（Service Account）是一种自动被启用的用户认证机制，使用经过签名的 持有者令牌来验证请求。服务账号通常由 API 服务器自动创建并通过 ServiceAccount 准入控制器 关联到集群中运行的 Pod 上。 持有者令牌会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。 服务账号也可以使用 Pod 规约的 serviceAccountName 字段显式地关联到 Pod 上。
  OpenID Connect（OIDC）令牌。OpenID Connect 是一种 OAuth2 认证方式， 被某些 OAuth2 提供者支持，例如 Azure 活动目录、Salesforce 和 Google。 协议对 OAuth2 的主要扩充体现在有一个附加字段会和访问令牌一起返回， 这一字段称作 ID Token（ID 令牌）。详情可参考 https://openid."><meta property="og:type" content="article"><meta property="og:url" content="/web/zh/blog/2021/12/18/tkestack-auth/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-12-18T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-18T00:00:00+00:00"><meta property="og:site_name" content="Tkestack"><meta itemprop=name content="TKEStack 中的认证与鉴权"><meta itemprop=description content="Author: LeoRyu
认证鉴权对于 K8s 而言可以说是最为复杂、灵活和关键的部分，本文将介绍 TKEStack 中认证鉴权机制是如何运作的。
开始之前 由于认证鉴权涉及的相关知识很多，为了避免读者在下面探究 TKEStack 认证鉴权机制时查处相关名词知识，在开始之前先介绍一些本文涉及到的知识概念。
K8s 中的一些身份认证方式   X509 客户证书。通过给 API 服务器传递 --client-ca-file=SOMEFILE 选项，就可以启动客户端证书身份认证。 所引用的文件必须包含一个或者多个证书机构，用来验证向 API 服务器提供的客户端证书。 如果提供了客户端证书并且证书被验证通过，则 subject 中的公共名称（Common Name）就被 作为请求的用户名。
  静态令牌文件。当 API 服务器的命令行设置了 --token-auth-file=SOMEFILE 选项时，会从文件中 读取持有者令牌。目前，令牌会长期有效，并且在不重启 API 服务器的情况下 无法更改令牌列表。
  服务账号令牌。服务账号（Service Account）是一种自动被启用的用户认证机制，使用经过签名的 持有者令牌来验证请求。服务账号通常由 API 服务器自动创建并通过 ServiceAccount 准入控制器 关联到集群中运行的 Pod 上。 持有者令牌会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。 服务账号也可以使用 Pod 规约的 serviceAccountName 字段显式地关联到 Pod 上。
  OpenID Connect（OIDC）令牌。OpenID Connect 是一种 OAuth2 认证方式， 被某些 OAuth2 提供者支持，例如 Azure 活动目录、Salesforce 和 Google。 协议对 OAuth2 的主要扩充体现在有一个附加字段会和访问令牌一起返回， 这一字段称作 ID Token（ID 令牌）。详情可参考 https://openid."><meta itemprop=datePublished content="2021-12-18T00:00:00+00:00"><meta itemprop=dateModified content="2021-12-18T00:00:00+00:00"><meta itemprop=wordCount content="386"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="TKEStack 中的认证与鉴权"><meta name=twitter:description content="Author: LeoRyu
认证鉴权对于 K8s 而言可以说是最为复杂、灵活和关键的部分，本文将介绍 TKEStack 中认证鉴权机制是如何运作的。
开始之前 由于认证鉴权涉及的相关知识很多，为了避免读者在下面探究 TKEStack 认证鉴权机制时查处相关名词知识，在开始之前先介绍一些本文涉及到的知识概念。
K8s 中的一些身份认证方式   X509 客户证书。通过给 API 服务器传递 --client-ca-file=SOMEFILE 选项，就可以启动客户端证书身份认证。 所引用的文件必须包含一个或者多个证书机构，用来验证向 API 服务器提供的客户端证书。 如果提供了客户端证书并且证书被验证通过，则 subject 中的公共名称（Common Name）就被 作为请求的用户名。
  静态令牌文件。当 API 服务器的命令行设置了 --token-auth-file=SOMEFILE 选项时，会从文件中 读取持有者令牌。目前，令牌会长期有效，并且在不重启 API 服务器的情况下 无法更改令牌列表。
  服务账号令牌。服务账号（Service Account）是一种自动被启用的用户认证机制，使用经过签名的 持有者令牌来验证请求。服务账号通常由 API 服务器自动创建并通过 ServiceAccount 准入控制器 关联到集群中运行的 Pod 上。 持有者令牌会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。 服务账号也可以使用 Pod 规约的 serviceAccountName 字段显式地关联到 Pod 上。
  OpenID Connect（OIDC）令牌。OpenID Connect 是一种 OAuth2 认证方式， 被某些 OAuth2 提供者支持，例如 Azure 活动目录、Salesforce 和 Google。 协议对 OAuth2 的主要扩充体现在有一个附加字段会和访问令牌一起返回， 这一字段称作 ID Token（ID 令牌）。详情可参考 https://openid."><link rel=preload href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css as=style><link href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/web/zh/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Tkestack</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/docs/><span>Docs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-webzhblog-li><a href=/web/zh/blog/ title="TKEStack 博客" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section tree-root" id=m-webzhblog><span>博客</span></a><ul class="pr-md-3 ul-1"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20220318tkestack-casbin-authz-li><a href=/web/zh/blog/2022/03/18/tkestack-casbin-authz/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20220318tkestack-casbin-authz><span>TKEStack授权链路源码解析</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20220223tkestack-installer-chart-li><a href=/web/zh/blog/2022/02/23/tkestack-installer-chart/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20220223tkestack-installer-chart><span>原生k8s集群上通过chart安装tke-auth、tke-platform、tke-gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20220104tkestack-ldap-li><a href=/web/zh/blog/2022/01/04/tkestack-ldap/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20220104tkestack-ldap><span>TKEStack 集成LDAP</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20211220hybrid-cloud-introduction-2-li><a href=/web/zh/blog/2021/12/20/hybrid-cloud-introduction-2/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20211220hybrid-cloud-introduction-2><span>TKEStack 容器混合云能力介绍（2）：打破网络边界</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-webzhblog20211218tkestack-auth-li><a href=/web/zh/blog/2021/12/18/tkestack-auth/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__page" id=m-webzhblog20211218tkestack-auth><span class=td-sidebar-nav-active-item>TKEStack 中的认证与鉴权</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20210901container-runtime-migraion-li><a href=/web/zh/blog/2021/09/01/container-runtime-migraion/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20210901container-runtime-migraion><span>TKEStack 集群容器运行时迁移</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20210802hybrid-cloud-introduction-1-li><a href=/web/zh/blog/2021/08/02/hybrid-cloud-introduction-1/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20210802hybrid-cloud-introduction-1><span>TKEStack 容器混合云能力介绍（1）：统一基石</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20210609tkestack-indtroduction-2021-li><a href=/web/zh/blog/2021/06/09/tkestack-indtroduction-2021/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20210609tkestack-indtroduction-2021><span>腾讯开源容器云平台 TKEStack 介绍</span></a></li></ul></li></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/tkestack/web/edit/master/content/zh/blog/2021-12-18-TKEStack%e4%b8%ad%e7%9a%84%e8%ae%a4%e8%af%81%e4%b8%8e%e9%89%b4%e6%9d%83/index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/tkestack/web/new/master/content/zh/blog/2021-12-18-TKEStack%e4%b8%ad%e7%9a%84%e8%ae%a4%e8%af%81%e4%b8%8e%e9%89%b4%e6%9d%83/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/tkestack/web/issues/new?title=TKEStack%20%e4%b8%ad%e7%9a%84%e8%ae%a4%e8%af%81%e4%b8%8e%e9%89%b4%e6%9d%83" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/web/zh/blog/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a></div><nav id=TableOfContents><ul><li><a href=#开始之前>开始之前</a><ul><li><a href=#k8s-中的一些身份认证方式>K8s 中的一些身份认证方式</a></li><li><a href=#k8s-中的一些鉴权方式>K8s 中的一些鉴权方式</a></li><li><a href=#casbin>Casbin</a></li></ul></li><li><a href=#两种认证鉴权场景>两种认证鉴权场景</a></li><li><a href=#由浏览器发起的访问>由浏览器发起的访问</a><ul><li><a href=#认证>认证</a></li><li><a href=#鉴权>鉴权</a></li></ul></li><li><a href=#集群内由-kubectl-发起的请求>集群内由 kubectl 发起的请求</a><ul><li><a href=#认证-1>认证</a></li><li><a href=#鉴权-1>鉴权</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>TKEStack 中的认证与鉴权</h1><div class="td-byline mb-4"><time datetime=2021-12-18 class=text-muted>2021.12.18</time></div><p><strong>Author</strong>: LeoRyu</p><p><em>认证鉴权对于 K8s 而言可以说是最为复杂、灵活和关键的部分，本文将介绍 TKEStack 中认证鉴权机制是如何运作的。</em></p><h2 id=开始之前>开始之前</h2><p>由于认证鉴权涉及的相关知识很多，为了避免读者在下面探究 TKEStack 认证鉴权机制时查处相关名词知识，在开始之前先介绍一些本文涉及到的知识概念。</p><h3 id=k8s-中的一些身份认证方式>K8s 中的一些身份认证方式</h3><ul><li><p>X509 客户证书。通过给 API 服务器传递 <code>--client-ca-file=SOMEFILE</code> 选项，就可以启动客户端证书身份认证。 所引用的文件必须包含一个或者多个证书机构，用来验证向 API 服务器提供的客户端证书。 如果提供了客户端证书并且证书被验证通过，则 subject 中的公共名称（Common Name）就被 作为请求的用户名。</p></li><li><p>静态令牌文件。当 API 服务器的命令行设置了 <code>--token-auth-file=SOMEFILE</code> 选项时，会从文件中 读取持有者令牌。目前，令牌会长期有效，并且在不重启 API 服务器的情况下 无法更改令牌列表。</p></li><li><p>服务账号令牌。服务账号（Service Account）是一种自动被启用的用户认证机制，使用经过签名的 持有者令牌来验证请求。服务账号通常由 API 服务器自动创建并通过 ServiceAccount 准入控制器 关联到集群中运行的 Pod 上。 持有者令牌会挂载到 Pod 中可预知的位置，允许集群内进程与 API 服务器通信。 服务账号也可以使用 Pod 规约的 serviceAccountName 字段显式地关联到 Pod 上。</p></li><li><p>OpenID Connect（OIDC）令牌。OpenID Connect 是一种 OAuth2 认证方式， 被某些 OAuth2 提供者支持，例如 Azure 活动目录、Salesforce 和 Google。 协议对 OAuth2 的主要扩充体现在有一个附加字段会和访问令牌一起返回， 这一字段称作 ID Token（ID 令牌）。详情可参考 <a href=https://openid.net/connect/>https://openid.net/connect/</a> 。</p></li></ul><p>更多认证相关信息可参考 <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/>用户认证</a>[1]。</p><h3 id=k8s-中的一些鉴权方式>K8s 中的一些鉴权方式</h3><ul><li>Node。一个专用鉴权组件，根据调度到 kubelet 上运行的 Pod 为 kubelet 授予权限。</li><li>ABAC。基于属性的访问控制（ABAC）定义了一种访问控制范型，通过使用将属性组合 在一起的策略，将访问权限授予用户。策略可以使用任何类型的属性（用户属性、资源属性、 对象，环境属性等）。</li><li>RBAC。基于角色的访问控制（RBAC）是一种基于企业内个人用户的角色来管理对 计算机或网络资源的访问的方法。在此上下文中，权限是单个用户执行特定任务的能力， 例如查看、创建或修改文件。</li><li>Webhook。WebHook 是一个 HTTP 回调：发生某些事情时调用的 HTTP POST； 通过 HTTP POST 进行简单的事件通知。实现 WebHook 的 Web 应用程序会在发生某些事情时 将消息发布到 URL。</li><li>AlwaysAllow。允许所有请求。仅在你不需要 API 请求 的鉴权时才使用。</li><li>AlwaysDeny。阻止所有请求。仅用于测试。</li></ul><p>更多认证相关信息可参考 <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authorization/>鉴权概述</a>[2]。</p><h3 id=casbin>Casbin</h3><p>Casbin 是一款轻量级的开源访问控制框架，支持 PERM 模式（Policy，Effect，Request，Matchers），相关概念如下：</p><ul><li>Request：定义了请求的元组对象，至少包含访问实体（sub）、访问的资源（obj）和行为（Action），例如：r={sub, obj,act}。</li><li>Policy：定义了鉴权规则各字段的名称和顺序，至少包含访问实体（sub）、访问的资源（obj）和行为（Action），例如：p={sub, obj, act}。</li><li>Matchers：定义了 Request 和 Policy 的匹配规则。</li><li>Effect：用于对所有 Matchers 匹配后的结果，再进行一次逻辑组合判断（例如：e = some(where (p.eft == allow)) && !some(where (p.eft == deny))，这个例子组合的逻辑含义是：如果有匹配出结果为 alllow 的策略，并且没有匹配出结果为 deny 的策略，则结果为真，如果有任何deny，都为假）。</li></ul><p>关于本项目详细信息可以参考 <a href=https://casbin.org/docs/zh-CN/overview>Casbin 概述</a>[3]。</p><h2 id=两种认证鉴权场景>两种认证鉴权场景</h2><p>TKEStack 扩展 K8s API 的方式是通过 aggregated apiserver[4] 实现的，这种方式与 CRD 的方式不同，每一个扩展组件都可以被视为一个独立的 APIServer，这使得 TKEStack 的认证鉴权相较之下更加灵活，但也更加复杂。为了更加方便和清晰地展示认证鉴权的流程，这里我们分为两种场景分别展开：第一种是用户通过浏览器由 tke-gateway 入口访问各个组件的资源；第二种是用户通过 kubectl 由 kube-apiserver 入口访问各个组件的资源。</p><h2 id=由浏览器发起的访问>由浏览器发起的访问</h2><h3 id=认证>认证</h3><p>用户通过浏览器登陆访问的用户信息并不是 K8s 集群可以识别的用户，无法由集群本身进行认证流程，需要外部的 OIDC provider 进行认证。在 TKEStack 中承担此工作的是 tke-auth 组件，tke-auth 中是通过 <a href=https://github.com/dexidp/dex>dex</a> 实现的 OIDC 服务。</p><p>在由浏览器发起的访问场景下，认证流程的链路大致分为两步骤：</p><ol><li><code>用户浏览器中登录 -> tke-gateway -> tke-auth返回认证信息凭证 -> 设置访问凭证到浏览器</code></li><li><code>已有访问凭证的前端 -> tke-gateway -> tke-xxxx -> tke-auth校验认证凭证</code></li></ol><p>整个认证过程中数据传输都是通过浏览器或是 TKEStack 系统组件完成的，没有 kube-apiserver 的参与。</p><h3 id=鉴权>鉴权</h3><p>当前版本 TKEStack 系统组件的鉴权模式默认是以 <a href=https://kubernetes.io/docs/reference/access-authn-authz/authorization/>SubjectAccessReview</a> 继承了 kube-apiserver 的鉴权模式，而 kube-apiserver 中鉴权模式配置了 webhook 指向了 tke-auth 组件。</p><p>tke-auth 中的鉴权是基于 <a href=https://github.com/casbin/casbin>casbin</a> 实现的，基于其 PERM 模型 TKEStack 完成了一套 RBAC 模型的实现：</p><pre><code>[request_definition]
r = sub, dom, obj, act

[policy_definition]
p = sub, dom, obj, act, eft

[role_definition]
g = _, _, _

[policy_effect]
e = some(where (p.eft == allow)) &amp;&amp; !some(where (p.eft == deny))

[matchers]
m = g(r.sub, p.sub, r.dom) &amp;&amp; keyMatchCustom(r.obj, p.obj) &amp;&amp; keyMatchCustom(r.act, p.act)
</code></pre><ul><li>request_definition：定义了模型的 Request</li><li>policy_definition：定义了模型的 Policy</li><li>role_definition：定义了模型的用户和角色的映射关系， 三个空缺分别表示用户, 角色, 域，TKEStack 使用的域为业务 ID</li><li>policy_effect：定义了模型的 Effect</li><li>matchers：定义了模型的匹配方式，keyMatchCustom 为自定义匹配函数，支持以正则匹配和通配符的方式，匹配 Role 和 Policy 的字段</li></ul><p>用户通过浏览器访问场景下 TKEStack 的鉴权流程整个链路如下：</p><p><code>用户浏览器发起请求 -> tke-gateway -> tke-xxx -> kube-apiserver webhook -> tke-auth返回鉴权结果</code></p><h2 id=集群内由-kubectl-发起的请求>集群内由 kubectl 发起的请求</h2><h3 id=认证-1>认证</h3><p>集群内通过 kubectl 发起请求场景下的认证流程与 K8s 本身的认证流程基本无异，因此整个链路也非常简单：</p><p><code>kubectl 读取 kubeconfig 中的认证信息 -> kube-apiserver 检验认证信息</code></p><p>由于此场景下的用户信息是可以被 K8s 识别的，且 kubectl 是直接连接 kube-apiserver 的，认证流程在请求到达 TKEStack 系统组件之前就完成了。</p><h3 id=鉴权-1>鉴权</h3><p>之前在由浏览器发起访问场景中已经提到 TKEStack 系统组件的鉴权模式是以 <a href=https://kubernetes.io/docs/reference/access-authn-authz/authorization/>SubjectAccessReview</a> 继承了 kube-apiserver 的鉴权模式，这种模式也同样适用于集群内由 kubectl 发起请求的场景，只不过在 kube-apiserver 中生效的鉴权模式不再是指向 tke-auth 的 webhook，而是 K8s 的 RBAC/ABAC 模式。</p><p>整个鉴权流程的链路如下：</p><p><code>kubectl 发起请求 -> kube-apiserver -> tke-xxx -> kube-apiserver 返回 RBAC/ABAC 鉴权结果</code></p><p>[1] Kubernetes 用户认证 [https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/]</p><p>[2] Kubernetes 鉴权概述 [https://kubernetes.io/zh/docs/reference/access-authn-authz/authorization/]</p><p>[3] Casbin 概述 [https://casbin.org/docs/zh-CN/overview]</p><p>[4] Kubernetes API Aggregation Layer [https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/]</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/web/zh/blog/2021/09/01/container-runtime-migraion/ aria-label="上一页 - TKEStack 集群容器运行时迁移" class="btn btn-primary"><span class=mr-1>←</span> 上一页</a></li><a href=/web/zh/blog/2021/12/20/hybrid-cloud-introduction-2/ aria-label="下一页 - TKEStack 容器混合云能力介绍（2）：打破网络边界" class="btn btn-primary">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/tkestack/tke aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The TKEStack Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/web/js/main.min.1911ee3ae98d7d6df3807cd00d8e31ae7d1c08ee0f0bb587529b0483da4e5464.js integrity="sha256-GRHuOumNfW3zgHzQDY4xrn0cCO4PC7WHUpsEg9pOVGQ=" crossorigin=anonymous></script></body></html>