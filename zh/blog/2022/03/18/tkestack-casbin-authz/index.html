<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/web/favicons/favicon.ico><link rel=apple-touch-icon href=/web/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/web/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/web/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/web/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/web/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/web/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/web/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/web/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/web/favicons/android-192x192.png sizes=192x192><title>TKEStack授权链路源码解析 | Tkestack</title><meta name=description content="生产级别多集群管理系统"><meta property="og:title" content="TKEStack授权链路源码解析"><meta property="og:description" content="Author: caryxychen
TKEStack 是一个开源项目，它为在生产环境中部署容器的组织提供了一个容器管理平台。TKEStack 让您可以轻松地在任何地方运行 Kubernetes、满足 IT 需求并为 DevOps 团队赋能。 本文将详细分析的TKEStack授权链路。
名词解释  Tenant  租户，类似于公有云主账号 TkeStack提供了多租户隔离的能力   Platform  平台级，即拥有全局的作用范围   Project  项目级，将资源、操作限定到某个项目维度下   User  用户，定义一个成员的最基础的认证信息 例如小明、小李是两个用户 用户属于某个租户 用户是平台级资源 CRD   Group  用户组，将一组用户关联到一个分组 例如小明和小李都是容器组的同事 用户组属于某个租户 用户组是平台级资源 CRD   Role  角色，一个中间态概念，关联了一组权限策略（Policy），并分配到用户、用户组上 例如小明是研发角色，小李是产品角色 角色可以是平台级（Platform），也可以是项目级（Project）  若将一个平台级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的平台级权限 若将一个项目级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的项目级权限   角色属于某个租户 CRD   Policy  权限策略，定义了Resouces、Actions、Effect三元组 权限策略可以是平台级（Platform），也可以是项目级（Project）  通过**(un)binding**将用户、用户组与**平台级Policy**绑定，这样用户、用户组具备了平台级的操作权限 通过project(un)Binding将用户、用户组与项目级Policy绑定，这样用户、用户组只在该项目下具备权限 若用户、用户组是通过Role关联了某些Policy，则权限的作用范围由Role的作用域决定   CRD    Casbin基础 Casbin 可以："><meta property="og:type" content="article"><meta property="og:url" content="/web/zh/blog/2022/03/18/tkestack-casbin-authz/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-03-18T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-18T00:00:00+00:00"><meta property="og:site_name" content="Tkestack"><meta itemprop=name content="TKEStack授权链路源码解析"><meta itemprop=description content="Author: caryxychen
TKEStack 是一个开源项目，它为在生产环境中部署容器的组织提供了一个容器管理平台。TKEStack 让您可以轻松地在任何地方运行 Kubernetes、满足 IT 需求并为 DevOps 团队赋能。 本文将详细分析的TKEStack授权链路。
名词解释  Tenant  租户，类似于公有云主账号 TkeStack提供了多租户隔离的能力   Platform  平台级，即拥有全局的作用范围   Project  项目级，将资源、操作限定到某个项目维度下   User  用户，定义一个成员的最基础的认证信息 例如小明、小李是两个用户 用户属于某个租户 用户是平台级资源 CRD   Group  用户组，将一组用户关联到一个分组 例如小明和小李都是容器组的同事 用户组属于某个租户 用户组是平台级资源 CRD   Role  角色，一个中间态概念，关联了一组权限策略（Policy），并分配到用户、用户组上 例如小明是研发角色，小李是产品角色 角色可以是平台级（Platform），也可以是项目级（Project）  若将一个平台级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的平台级权限 若将一个项目级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的项目级权限   角色属于某个租户 CRD   Policy  权限策略，定义了Resouces、Actions、Effect三元组 权限策略可以是平台级（Platform），也可以是项目级（Project）  通过**(un)binding**将用户、用户组与**平台级Policy**绑定，这样用户、用户组具备了平台级的操作权限 通过project(un)Binding将用户、用户组与项目级Policy绑定，这样用户、用户组只在该项目下具备权限 若用户、用户组是通过Role关联了某些Policy，则权限的作用范围由Role的作用域决定   CRD    Casbin基础 Casbin 可以："><meta itemprop=datePublished content="2022-03-18T00:00:00+00:00"><meta itemprop=dateModified content="2022-03-18T00:00:00+00:00"><meta itemprop=wordCount content="468"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="TKEStack授权链路源码解析"><meta name=twitter:description content="Author: caryxychen
TKEStack 是一个开源项目，它为在生产环境中部署容器的组织提供了一个容器管理平台。TKEStack 让您可以轻松地在任何地方运行 Kubernetes、满足 IT 需求并为 DevOps 团队赋能。 本文将详细分析的TKEStack授权链路。
名词解释  Tenant  租户，类似于公有云主账号 TkeStack提供了多租户隔离的能力   Platform  平台级，即拥有全局的作用范围   Project  项目级，将资源、操作限定到某个项目维度下   User  用户，定义一个成员的最基础的认证信息 例如小明、小李是两个用户 用户属于某个租户 用户是平台级资源 CRD   Group  用户组，将一组用户关联到一个分组 例如小明和小李都是容器组的同事 用户组属于某个租户 用户组是平台级资源 CRD   Role  角色，一个中间态概念，关联了一组权限策略（Policy），并分配到用户、用户组上 例如小明是研发角色，小李是产品角色 角色可以是平台级（Platform），也可以是项目级（Project）  若将一个平台级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的平台级权限 若将一个项目级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的项目级权限   角色属于某个租户 CRD   Policy  权限策略，定义了Resouces、Actions、Effect三元组 权限策略可以是平台级（Platform），也可以是项目级（Project）  通过**(un)binding**将用户、用户组与**平台级Policy**绑定，这样用户、用户组具备了平台级的操作权限 通过project(un)Binding将用户、用户组与项目级Policy绑定，这样用户、用户组只在该项目下具备权限 若用户、用户组是通过Role关联了某些Policy，则权限的作用范围由Role的作用域决定   CRD    Casbin基础 Casbin 可以："><link rel=preload href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css as=style><link href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/web/zh/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Tkestack</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/docs/><span>Docs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-webzhblog-li><a href=/web/zh/blog/ title="TKEStack 博客" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section tree-root" id=m-webzhblog><span>博客</span></a><ul class="pr-md-3 ul-1"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-webzhblog20220318tkestack-casbin-authz-li><a href=/web/zh/blog/2022/03/18/tkestack-casbin-authz/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__page" id=m-webzhblog20220318tkestack-casbin-authz><span class=td-sidebar-nav-active-item>TKEStack授权链路源码解析</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20220223tkestack-installer-chart-li><a href=/web/zh/blog/2022/02/23/tkestack-installer-chart/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20220223tkestack-installer-chart><span>原生k8s集群上通过chart安装tke-auth、tke-platform、tke-gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20220104tkestack-ldap-li><a href=/web/zh/blog/2022/01/04/tkestack-ldap/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20220104tkestack-ldap><span>TKEStack 集成LDAP</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20211220hybrid-cloud-introduction-2-li><a href=/web/zh/blog/2021/12/20/hybrid-cloud-introduction-2/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20211220hybrid-cloud-introduction-2><span>TKEStack 容器混合云能力介绍（2）：打破网络边界</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20211218tkestack-auth-li><a href=/web/zh/blog/2021/12/18/tkestack-auth/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20211218tkestack-auth><span>TKEStack 中的认证与鉴权</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20210901container-runtime-migraion-li><a href=/web/zh/blog/2021/09/01/container-runtime-migraion/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20210901container-runtime-migraion><span>TKEStack 集群容器运行时迁移</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20210802hybrid-cloud-introduction-1-li><a href=/web/zh/blog/2021/08/02/hybrid-cloud-introduction-1/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20210802hybrid-cloud-introduction-1><span>TKEStack 容器混合云能力介绍（1）：统一基石</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-webzhblog20210609tkestack-indtroduction-2021-li><a href=/web/zh/blog/2021/06/09/tkestack-indtroduction-2021/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-webzhblog20210609tkestack-indtroduction-2021><span>腾讯开源容器云平台 TKEStack 介绍</span></a></li></ul></li></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/tkestack/web/edit/master/content/zh/blog/2022-03-18-TKEStack%e6%8e%88%e6%9d%83%e9%93%be%e8%b7%af%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90/index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/tkestack/web/new/master/content/zh/blog/2022-03-18-TKEStack%e6%8e%88%e6%9d%83%e9%93%be%e8%b7%af%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/tkestack/web/issues/new?title=TKEStack%e6%8e%88%e6%9d%83%e9%93%be%e8%b7%af%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/web/zh/blog/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a></div><nav id=TableOfContents><ul><li><a href=#名词解释>名词解释</a></li><li><a href=#casbin基础httpscasbinorgdocszh-cnoverview><a href=https://casbin.org/docs/zh-CN/overview>Casbin基础</a></a><ul><li><a href=#permhttpscasbinorgdocszh-cnhow-it-works><a href=https://casbin.org/docs/zh-CN/how-it-works>PERM</a></a></li><li><a href=#rbachttpscasbinorgdocszh-cnrbac><a href=https://casbin.org/docs/zh-CN/rbac>RBAC</a></a></li><li><a href=#域内rbachttpscasbinorgdocszh-cnrbac-with-domains><a href=https://casbin.org/docs/zh-CN/rbac-with-domains>域内RBAC</a></a></li><li><a href=#角色继承httpscasbinorgdocszh-cnrbace5a682e4bd95e58cbae58886e794a8e688b7e5928ce8a792e889b2efbc9f><a href=https://casbin.org/docs/zh-CN/rbac#%E5%A6%82%E4%BD%95%E5%8C%BA%E5%88%86%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2%EF%BC%9F>角色继承</a></a></li></ul></li><li><a href=#tkestack-authz源码解析>TkeStack Authz源码解析</a><ul><li><a href=#casbin模型定义>Casbin模型定义</a></li><li><a href=#tke-auth-api授权解析>tke-auth-api授权解析</a></li><li><a href=#tke-auth-controller>tke-auth-controller</a></li><li><a href=#示例>示例</a></li><li><a href=#其他模块的授权链路>其他模块的授权链路</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>TKEStack授权链路源码解析</h1><div class="td-byline mb-4"><time datetime=2022-03-18 class=text-muted>2022.03.18</time></div><p><strong>Author</strong>: caryxychen</p><p><a href=https://github.com/tkestack/tke>TKEStack</a> 是一个开源项目，它为在生产环境中部署容器的组织提供了一个容器管理平台。TKEStack 让您可以轻松地在任何地方运行 Kubernetes、满足 IT 需求并为 DevOps 团队赋能。
本文将详细分析的TKEStack授权链路。</p><h2 id=名词解释>名词解释</h2><p><img src=./tkestack%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B.png alt=image.png></p><ul><li>Tenant<ul><li>租户，类似于公有云主账号</li><li>TkeStack提供了多租户隔离的能力</li></ul></li><li>Platform<ul><li>平台级，即拥有全局的作用范围</li></ul></li><li>Project<ul><li>项目级，将资源、操作限定到某个项目维度下</li></ul></li><li>User<ul><li>用户，定义一个成员的最基础的认证信息</li><li>例如小明、小李是两个用户</li><li>用户属于某个租户</li><li>用户是平台级资源</li><li><a href=https://github.com/tkestack/tke/blob/master/api/auth/types.go#L201>CRD</a></li></ul></li><li>Group<ul><li>用户组，将一组用户关联到一个分组</li><li>例如小明和小李都是容器组的同事</li><li>用户组属于某个租户</li><li>用户组是平台级资源</li><li><a href=https://github.com/tkestack/tke/blob/master/api/auth/types.go#L240>CRD</a></li></ul></li><li>Role<ul><li>角色，一个中间态概念，关联了一组权限策略（Policy），并分配到用户、用户组上</li><li>例如小明是<strong>研发</strong>角色，小李是<strong>产品</strong>角色</li><li>角色可以是平台级（Platform），也可以是项目级（Project）<ul><li>若将一个平台级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的平台级权限</li><li>若将一个项目级的角色绑定到某个用户、用户组上，则用户、用户组具备了该角色所绑定了权限策略的项目级权限</li></ul></li><li>角色属于某个租户</li><li><a href=https://github.com/tkestack/tke/blob/master/api/auth/types.go#L744>CRD</a></li></ul></li><li>Policy<ul><li>权限策略，<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Authority/%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AD%96%E7%95%A5.md>定义了Resouces、Actions、Effect三元组</a></li><li>权限策略可以是平台级（Platform），也可以是项目级（Project）<ul><li>通过**(un)binding**将用户、用户组与**平台级Policy**绑定，这样用户、用户组具备了平台级的操作权限</li><li>通过<strong>project(un)Binding</strong>将用户、用户组与<strong>项目级Policy</strong>绑定，这样用户、用户组只在该项目下具备权限</li><li>若用户、用户组是通过Role关联了某些Policy，则权限的作用范围由Role的作用域决定</li></ul></li><li><a href=https://github.com/tkestack/tke/blob/master/api/auth/types.go#L490>CRD</a></li></ul></li></ul><h2 id=casbin基础httpscasbinorgdocszh-cnoverview><a href=https://casbin.org/docs/zh-CN/overview>Casbin基础</a></h2><p>Casbin 可以：</p><ul><li>支持自定义请求的格式，默认的请求格式为{subject, object, action}。</li><li>具有访问控制模型model和策略policy两个核心概念。</li><li>支持RBAC中的多层角色继承，不止主体可以有角色，资源也可以具有角色。</li><li>支持内置的超级用户 例如：root 或 administrator。超级用户可以执行任何操作而无需显式的权限声明。</li><li>支持多种内置的操作符，如 keyMatch，方便对路径式的资源进行管理，如 /foo/bar 可以映射到 /foo*</li></ul><p>Casbin 不能：</p><ul><li>身份认证 authentication（即验证用户的用户名和密码），Casbin 只负责访问控制。应该有其他专门的组件负责身份认证，然后由 Casbin 进行访问控制，二者是相互配合的关系。</li><li>管理用户列表或角色列表。 Casbin 认为由项目自身来管理用户、角色列表更为合适， 用户通常有他们的密码，但是 Casbin 的设计思想并不是把它作为一个存储密码的容器。 而是存储RBAC方案中用户和角色之间的映射关系。</li></ul><h3 id=permhttpscasbinorgdocszh-cnhow-it-works><a href=https://casbin.org/docs/zh-CN/how-it-works>PERM</a></h3><p>在 Casbin 中, 访问控制模型被抽象为基于 **PERM (Policy, Effect, Request, Matcher) **的一个文件。 PERM模式由四个基础（政策、效果、请求、匹配）组成，描述了资源与用户之间的关系。</p><p>Casbin需要两份文件：</p><ul><li>模型文件，定义了PERM，描述了权限控制模型的Schema<ul><li><a href=https://casbin.org/docs/zh-CN/syntax-for-models>https://casbin.org/docs/zh-CN/syntax-for-models</a></li><li><img src=./casbin-1.png alt=image.png></li><li>r，描述了请求的schema<ul><li>sub，主体对象，即请求发起方是谁</li><li>obj，资源对象，即被操作的资源是什么</li><li>act，动作，即触发什么类型的操作（CRUD）</li></ul></li><li>p，定义了策略文件的格式</li><li>m，匹配器，定义了请求与策略的匹配规则，即策略文件中的哪些策略能够被命中</li><li>e，效果器，通过被命中的策略，计算出最终的准入结果（Allow还是Deny）</li></ul></li><li>策略文件，根据模型文件中的p，填充用户自定义的授权规则<ul><li><img src=./casbin-2.png alt=image.png></li><li>alice可以读取data1</li><li>bob可以编写data2</li></ul></li></ul><h3 id=rbachttpscasbinorgdocszh-cnrbac><a href=https://casbin.org/docs/zh-CN/rbac>RBAC</a></h3><ul><li>模型定义<ul><li><img src=./casbin-3.png alt=image.png></li><li>分组定义，描述了<strong>用户与角色（分组）之间的关系</strong></li><li>匹配定义，g(r.sub, p.sub)描述了，<strong>请求的主体与策略里的主体，需要在同一个角色（分组）里</strong></li></ul></li><li>策略文件<ul><li><img src=./casbin-4.png alt=image.png></li><li>alice对data1资源有read权限</li><li>data2_admin角色对data2资源有read、write权限</li><li>alice属于data2_admin角色（分组），因此alice也具备了data2资源的read、write权限</li><li>bob只有data2资源的write权限</li></ul></li></ul><h3 id=域内rbachttpscasbinorgdocszh-cnrbac-with-domains><a href=https://casbin.org/docs/zh-CN/rbac-with-domains>域内RBAC</a></h3><ul><li>模型定义<ul><li><img src=./casbin-5.png alt=image.png></li><li>域内角色定义，<strong>用户，角色，域的分组关系</strong></li><li>匹配规则，请求的作用域内的请求主体，应该与策略文件中的主体在一个分组内</li></ul></li><li>策略文件<ul><li><img src=./casbin-6.png alt=image.png></li><li><strong>admin角色</strong>在<strong>domain1、domain2作用域内</strong>，对<strong>data1、data2资源</strong>具备<strong>read、write权限</strong></li><li><strong>alice用户</strong>在<strong>domain1作用域</strong>具有<strong>admin角色</strong>权限，但不具备<strong>domain2作用域</strong>内资源的操作权限</li><li><strong>bob用户</strong>在<strong>domain2作用域</strong>具有<strong>admin角色</strong>权限，但不具备<strong>domain1作用域</strong>内资源的操作权限</li></ul></li></ul><h3 id=角色继承httpscasbinorgdocszh-cnrbace5a682e4bd95e58cbae58886e794a8e688b7e5928ce8a792e889b2efbc9f><a href=https://casbin.org/docs/zh-CN/rbac#%E5%A6%82%E4%BD%95%E5%8C%BA%E5%88%86%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2%EF%BC%9F>角色继承</a></h3><ul><li>模型定义<ul><li><img src=./casbin-7.png alt=image.png></li></ul></li><li>策略文件<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>p, role::admin, domain, data1, <span style=color:#204a87>read</span>
p, role::admin, domain, data1, write
p, role::reader, domain, data1, <span style=color:#204a87>read</span>

g, user::alice, group::develop, domain
g, user::bob, group::develop, domain
g, user::tony, group::product, domain

g, group::develop, role::admin, domain
g, group::product, role::reader, domain
</code></pre></div><ul><li><strong>用户alice、用户bob</strong>在<strong>domain作用域内</strong>属于<strong>用户组develop</strong></li><li><strong>用户bob</strong>在<strong>domain作用域</strong>内属于<strong>用户组produc</strong>t</li><li><strong>用户组develop</strong>在<strong>domain作用域</strong>内分配了<strong>admin角色</strong></li><li><strong>用户组product</strong>在<strong>domain作用域</strong>内分配了<strong>reader角色</strong></li><li><strong>admin角色</strong>在<strong>domain作用域</strong>内对<strong>data1资源</strong>具备<strong>read、write操作</strong>的权限</li><li><strong>reader角色</strong>在<strong>domain作用域</strong>内对<strong>data1资源</strong>具备<strong>read的权限</strong></li><li><strong>用户alice、bob</strong>在<strong>domain作用域</strong>内对<strong>data1资源</strong>具备<strong>read、write操作</strong>的权限</li><li><strong>用户tony</strong>在<strong>domain作用域内</strong>对<strong>data1资源</strong>具备<strong>read</strong>的权限</li></ul></li><li>即描述了用户、用户组、角色的三层继承关系<ul><li><img src=./casbin-8.png alt=image.png></li></ul></li></ul><h2 id=tkestack-authz源码解析>TkeStack Authz源码解析</h2><h3 id=casbin模型定义>Casbin模型定义</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>request_definition<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> sub, dom, obj, act

<span style=color:#ce5c00;font-weight:700>[</span>policy_definition<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> sub, dom, obj, act, eft

<span style=color:#ce5c00;font-weight:700>[</span>role_definition<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>=</span> _, _, _

<span style=color:#ce5c00;font-weight:700>[</span>policy_effect<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> some<span style=color:#ce5c00;font-weight:700>(</span>where <span style=color:#ce5c00;font-weight:700>(</span>p.eft <span style=color:#ce5c00;font-weight:700>==</span> allow<span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> !some<span style=color:#ce5c00;font-weight:700>(</span>where <span style=color:#ce5c00;font-weight:700>(</span>p.eft <span style=color:#ce5c00;font-weight:700>==</span> deny<span style=color:#ce5c00;font-weight:700>))</span>

<span style=color:#ce5c00;font-weight:700>[</span>matchers<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> g<span style=color:#ce5c00;font-weight:700>(</span>r.sub, p.sub, r.dom<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> keyMatchCustom<span style=color:#ce5c00;font-weight:700>(</span>r.obj, p.obj<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> keyMatchCustom<span style=color:#ce5c00;font-weight:700>(</span>r.act, p.act<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><ul><li><a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/api/auth/types.go#L633>DefaultRuleModel</a></li><li>域内RBAC</li><li>自定义的匹配函数<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/cmd/tke-auth-api/app/config/config.go#L413>keyMatchCustom</a></li><li>准入规则：策略集合中至少存在一条规则为allow，且不存在deny</li></ul><h3 id=tke-auth-api授权解析>tke-auth-api授权解析</h3><p><img src=./k8s-3a.png alt=image.png></p><ul><li><p>tke-auth-api是一个Aggregate ApiServer</p></li><li><p>请求<a href=https://github.com/tkestack/tke/blob/master/pkg/apiserver/handler/chain.go#L37>执行链</a>上包含：Authentication（认证）、Audit（审计）、TKEAuthorization（审计）</p></li><li><p>WithTKEAuthorization函数内调用<a href=https://github.com/tkestack/tke/blob/master/pkg/auth/filter/filter.go#L145>Authorizer</a>对请求进行授权</p></li><li><p>构造Authorizer</p><ul><li>tke-auth-api config中<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/cmd/tke-auth-api/app/config/config.go#L164>初始化Aggregation Authorizer</a></li><li>Aggregation Authorizer的<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/pkg/auth/authorization/aggregation/aggregation.go#L33>初始化逻辑</a></li><li>Local Authorizer（<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/pkg/auth/authorization/aggregation/aggregation.go#L59>Casbin Authorizer</a>）</li></ul></li><li><p>Casbin Authorizer的<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/pkg/auth/authorization/local/authorizer.go#L142>执行</a></p><ul><li>参考：<a href=https://casbin.org/docs/zh-CN/api-overview>Casbin API</a></li></ul></li><li><p>tke-auth-api config中<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/cmd/tke-auth-api/app/config/config.go#L148>初始化</a>Casbin Enforcer（执行器）</p><ul><li><a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/cmd/tke-auth-api/app/config/config.go#L303>加载DefaultRuleModel</a>，但Casbin的Policy来自哪里？</li></ul></li><li><p>tke-auth-api postStart中，执行Casbin <a href=https://github.com/tkestack/tke/blob/master/pkg/auth/apiserver/apiserver.go#L233>Policy加载</a></p><ul><li>构造Casbin <a href=https://github.com/tkestack/tke/blob/master/pkg/auth/authorization/local/hook_adapter.go#L61>Adapter</a></li><li>参考：<a href=https://casbin.org/docs/zh-CN/adapters>Casbin Adapter</a></li></ul></li><li><p>Casbin Policy的装载与存储</p><ul><li><a href=https://github.com/tkestack/tke/blob/master/pkg/auth/util/adapter.go#L72>装载</a></li><li><a href=https://github.com/tkestack/tke/blob/master/pkg/auth/util/adapter.go#L107>存储</a></li><li><a href=https://github.com/tkestack/tke/blob/master/pkg/auth/authorization/local/hook_adapter.go#L68>AutoLoad</a></li></ul></li><li><p>Rule <a href=https://github.com/tkestack/tke/blob/master/api/auth/types.go#L675>CRD</a></p><ul><li><img src=./rule.png alt=image.png></li><li><img src=./load-policy.png alt=image.png></li></ul><p><strong>用户直接向tke-auth-api提交Rule资源？？？太底层，没有高层抽象（用户、用户组、角色等）</strong></p></li></ul><h3 id=tke-auth-controller>tke-auth-controller</h3><p><img src=./controller.png alt=image.png>
包含的Controller</p><ul><li><a href=https://github.com/tkestack/tke/blob/master/cmd/tke-auth-controller/app/controller.go#L50>https://github.com/tkestack/tke/blob/master/cmd/tke-auth-controller/app/controller.go#L50</a></li><li><a href=https://github.com/tkestack/tke/blob/master/cmd/tke-auth-controller/app/auth.go#L60>https://github.com/tkestack/tke/blob/master/cmd/tke-auth-controller/app/auth.go#L60</a></li></ul><p><img src=./tkestack%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B.png alt=image.png>
Controller的职责</p><ul><li>以Policy为核心，将Policy绑定到User、Group、Role上</li><li>将Policy以及Policy的绑定关系，翻译成Casbin的策略规则（p、g）</li></ul><p><a href=https://github.com/tkestack/tke/blob/master/pkg/auth/controller/policy/policy_controller.go#L238>PolicyController</a>，watch <a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/api/auth/types.go#L442>Policy资源</a>，并更新Casbin策略规则。<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Authority/%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AD%96%E7%95%A5.md#%E7%AD%96%E7%95%A5%E6%A0%B7%E4%BE%8B>示例</a></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>p, pol-xxx, *, cluster:cls-123/deployment:deploy-123/*, get*, allow
p, pol-xxx, *, cluster:cls-123/deployment:deploy-123/*, list*, allow
p, pol-xxx, *, cluster:cls-123/deployment:deploy-123/*, watch*, allow
</code></pre></div><p>若Policy为Platform级别的，并且绑定到对应的User或Group上，则更新Casbin分组规则，示例：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>g, usr-xxx, pol-xxx, *
g, grp-xxx, pol-xxx, *
</code></pre></div><p><a href=https://github.com/tkestack/tke/blob/master/pkg/auth/controller/projectpolicybinding/projectpolicybinding_controller.go#L75>ProjectPolicyController</a>，watch <a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/api/auth/types.go#L533>ProjectPolicyBinding</a>资源，并更新Casbin分组规则。
若该Policy为Project级别的，并且通过ProjectBinding绑定到对应的User或Group上，则更新Casbin分组规则，示例：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>g, usr-xxx, pol-xxx, pro-xxx
g, grp-xxx, pol-xxx, pro-xxx
</code></pre></div><p><a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/pkg/auth/controller/role/role_controller.go#L72>RoleController</a>，watch <a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/api/auth/types.go#L712>Role</a>资源，并更新Casbin分组规则（多层继承）。
若将Role绑定（binding）到User或Group上，则更新Casbin的分组规则，示例：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic>## 若role-xxx是platform范围的</span>
g, usr-xxx, role-xxx, *
g, grp-xxx, role-xxx, *

<span style=color:#8f5902;font-style:italic>## 若role-yyy是project-yyy范围的</span>
g, usr-yyy, role-yyy, project-yyy
g, grp-yyy, role-yyy, project-yyy
</code></pre></div><p>若将Role关联（policyBinding）到多个Policy，则更新Casbin的分组规则，示例：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic>## 若role-xxx是platform范围的</span>
g, role-xxx, pol-xxx, *
g, role-xxx, pol-xxx2, *


<span style=color:#8f5902;font-style:italic>## 若role-yyy是project-yyy范围的</span>
g, role-yyy, pol-yyy, project-yyy
g, role-yyy, pol-yyy2, project-yyy
</code></pre></div><p><a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/pkg/auth/controller/group/group_controller.go#L78>GroupController</a>，watch <a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/api/auth/types.go#L134>LocalGroup</a>资源，并根据Group对应的User更新Casbin分组规则，示例：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>g, usr-xxx, grp-xxx, *
g, usr-xxx2, grp-xxx, *
g, usr-yyy, grp-yyy, *
</code></pre></div><h3 id=示例>示例</h3><p>TKEStack 通过自定义的 CRD：Policy 对象存储鉴权规则。其中 Policy 对象类似于 Kubernetes 中的 Clusterrole 或者 Role 对象，以近似于腾讯 CAM 语法的方式，定义了鉴权规则：
<img src=./get-policy.png alt=image.png></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth.tkestack.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2022-01-13T07:01:07Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>generateName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pol-</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pol-2tg5rdqf</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;916&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>23b81f6e-ac0d-4bbc-969b-864de22f917a</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>addon</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>该策略允许您管理平台租户内扩展组件相关资源</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>displayName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AddonFullAccess</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>finalizers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scope</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>actions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Addon*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Addons*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Addontype*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Addontypes*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Clusteraddontype*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Clusteraddontypes*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Coredns*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Cronhpa*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Cronhpas*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Csi*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Csioperator*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Csioperators*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Csis*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Galaxies*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Galaxy*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Gpumanager*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Gpumanagers*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Logc*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Logcs*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Persistentevent*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Persistentevents*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Prometheuse*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Prometheuses*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Tappcontroller*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*Tappcontrollers*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>effect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#39;*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tenantID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>groups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>phase</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Active</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Policy 对象通过 <strong>spec.statement</strong> 字段定义了鉴权策略的行为（actions）和资源（resources），分为平台策略（spec.scope!=project）和业务策略（spec.scope==project）：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth.tkestack.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pol-prj-default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>common</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>displayName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>finalizers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scope</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>project</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>actions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>createDeployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>deleteDeployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>getDeployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>listDeployments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>updateDeployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>effect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>cluster:cls-xxxxxxx/namespace:*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tenantID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth.tkestack.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ProjectPolicyBinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>prj-fwxqdm6b-pol-prj-default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>finalizers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>projectpolicybinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>groups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>policyID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pol-prj-default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>projectID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>prj-fwxqdm6b</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tenantID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>usr-test-default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Policy 对象定义了用户需要配置的鉴权规则格式，但是 Policy 对象实际上定义了一批规则的集合，Casbin 没法直接读取，因此还需要另一个 CRD 对象，将 Policy 转化为逐条的规则。例如：
<img src=./get-rule.png alt=image.png></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth.tkestack.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Rule</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2022-03-08T06:46:36Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>generateName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rul-</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rul-2rh67m4s</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;28896514&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a81f4f7f-88ef-418c-bb93-1d7ccdb02349</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ptype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>g</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default##user##test</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pol-default-project</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>prj-rggwcclx</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v4</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v5</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v6</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth.tkestack.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Rule</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2022-01-13T07:01:09Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>generateName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rul-</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rul-zzslddhh</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1075&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>0adb223f-6d05-4486-b714-18de368a68c6</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ptype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>p</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pol-default-project-member</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>deleteJob</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v4</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>allow</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v5</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>v6</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Rule 对象可以分为两类：spec.ptype==p 和 spec.ptype==g，分别对应 Casbin 模型里的policy_defination 和 role_defination：</p><ul><li>根据 g 规则可以确定用户所在的业务以及关联的 Policy 对象</li><li>根据 p 规则可以确定用户关联的 Policy 规定了哪些可执行的动作</li></ul><p>tke-auth-controller 根据 Casbin 定义的 Adapter Interface，通过 tke-auth-api 的 Client 和 Rule 对象的 Lister 对象构建了一个 Adapt。通过 Adapt 创建了 Casbin 的客户端，实现 Kubernetes 同 Casbin 框架的交互。</p><h3 id=其他模块的授权链路>其他模块的授权链路</h3><p>通过在<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/pkg/auth/handler/authz/handler.go#L62>WithTKEAuthorization</a>阶段，通过Webhook的方式，访问tke-auth-api的<a href=https://github.com/tkestack/tke/blob/9a001b7065aab6553d3310ddf748fb8abe9fb684/pkg/auth/route/auth.go#L34>/authz接口</a>
<img src=./authz.png alt=image.png></p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/web/zh/blog/2022/02/23/tkestack-installer-chart/ aria-label="上一页 - 原生k8s集群上通过chart安装tke-auth、tke-platform、tke-gateway" class="btn btn-primary"><span class=mr-1>←</span> 上一页</a></li><a class="btn btn-primary disabled">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/tkestack/tke aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The TKEStack Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/web/js/main.min.1911ee3ae98d7d6df3807cd00d8e31ae7d1c08ee0f0bb587529b0483da4e5464.js integrity="sha256-GRHuOumNfW3zgHzQDY4xrn0cCO4PC7WHUpsEg9pOVGQ=" crossorigin=anonymous></script></body></html>